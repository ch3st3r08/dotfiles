- name: OS | Installing essential packages
  community.general.pacman:
    name: "{{items}}"
    state: present
  with_items: "{{os_essential}}"

- name: "OS | Installing networking packages and services"
  block:
    - name: Installing networking packages
      community.general.pacman:
        name: "{{items}}"
      with_items: "{{os_network}}"

    - name: "Starting and enabling networkmanager service"
      ansible.builtin.systemd_service:
        name: NetworkManager.service
        enabled: true
        state: started

- name: "OS | Installing audio packages"
  block:
    - name: "Installing packages"
      community.general.pacman:
        name: "{{items}}"
      with_items: "{{os_audio}}"

    - name: "Enable and Start Pipewire systemd user unit"
      ansible.builtin.systemd_service:
        name: pipewire.service
        enabled: true
        state: started
        scope: user

- name: "OS | Setting Libcredential"
  block:
    - name: Check if libsecret credential program exists
      ansible.builtin.stat:
        path: /usr/share/git/credential/libsecret/git-credential-libsecret
      register: lib_secret_file_status

    - name: "Compiling git libsecret credential"
      ansible.builtin.command:
        cmd: make
        chdir: /usr/share/git/credential/libsecret/
      become: true
      changed_when: not lib_secret_file_status.stat.exists

- name: Copy git configuration
  ansible.builtin.command:
    cmd: stow -d {{root_dir}}/../ -t {{home}} --no-folding --dotfiles -S git
  register: my_output
  changed_when: my_output.rc != 0

- name: "Install Paru AUR manager"
  import_tasks: paru.yml
