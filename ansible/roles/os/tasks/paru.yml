---

- name: "Test if paru is already installed"
  command: command -v paru
  register: paru_exist
  ignore_errors: true
  changed_when: false

- name: Installing Paru AUR Helper
  when: paru_exist is failed
  block:
    - name: Clone Paru repository
      git:
        repo: https://aur.archlinux.org/paru-bin.git
        dest: ~/paru
        update: true
        version: master

    - name: Build and Install Paru package
      ansible.builtin.command:
        chdir: ~/paru
        cmd: makepkg -si --noconfirm
      register: parumake
      changed_when: parumake.rc != 0

    - name: Clean up build files
      file:
        path: ~/paru
        state: absent
  rescue:
    - name: Could not install Paru
      debug:
        msg: "Installation failed. Cleaning up and exiting."

    - name: Exitting gracefully
      fail:
        msg: "Deployment aborted due to package installation failure"
